<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é€‰æ‹©ä½ç½®</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { margin: 0; height: 100%; overflow: hidden; background: #0f172a; color: #e2e8f0; font-family: "Segoe UI", "PingFang SC", sans-serif; }
  
  /* å¤´éƒ¨æ ·å¼ */
  .header {
    background: rgba(30, 41, 59, 0.95);
    padding: 16px 20px;
    text-align: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 10;
    position: relative;
    backdrop-filter: blur(10px);
  }
  h1 { font-size: 1.2em; margin: 0; color: #fff; letter-spacing: 1px; }
  .info { font-size: 0.8em; color: #94a3b8; margin-top: 5px; }

  /* åœ°å›¾å®¹å™¨ */
  #map { width: 100%; height: calc(100% - 140px); }

  /* åº•éƒ¨æ§ä»¶ */
  .controls {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: rgba(15, 23, 42, 0.95);
    padding: 20px;
    border-top: 1px solid rgba(255,255,255,0.1);
    z-index: 100;
    display: flex; flex-direction: column; gap: 12px;
    backdrop-filter: blur(10px);
    box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
  }
  .coord-display {
    font-size: 13px; color: #cbd5e1; text-align: center;
    background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.05);
  }
  .btn-group { display: flex; gap: 12px; }
  button {
    flex: 1; padding: 14px; border: none; border-radius: 10px;
    font-weight: 600; cursor: pointer; transition: all 0.2s;
    font-size: 15px;
  }
  
  /* ç¡®è®¤æŒ‰é’® */
  .confirm-btn { 
    background: linear-gradient(135deg, #3b82f6, #2563eb); 
    color: white; 
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
  }
  .confirm-btn:active { transform: scale(0.98); }
  .confirm-btn:disabled { 
    background: #475569; color: #94a3b8; 
    box-shadow: none; cursor: not-allowed; opacity: 0.7;
  }

  /* çº ååˆ‡æ¢æŒ‰é’® */
  .fix-btn { 
    background: rgba(255,255,255,0.1); 
    color: #e2e8f0; 
    border: 1px solid rgba(255,255,255,0.1);
    flex: 0.6; /* è®©ç¡®è®¤æŒ‰é’®å®½ä¸€ç‚¹ */
  }
  .fix-btn:active { background: rgba(255,255,255,0.2); }

  /* å®šä½æŒ‰é’® */
  .locate-btn {
    position: fixed; bottom: 170px; right: 20px;
    width: 48px; height: 48px; border-radius: 50%;
    background: #3b82f6; color: white; border: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    font-size: 22px; z-index: 99; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.2s;
  }
  .locate-btn:active { transform: scale(0.9); }

  /* æç¤ºæ¡† */
  .toast {
    position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.85); color: white; padding: 10px 24px;
    border-radius: 30px; font-size: 14px; opacity: 0; pointer-events: none;
    transition: opacity 0.3s; z-index: 9999; backdrop-filter: blur(4px);
  }
</style>

<script src="https://webapi.amap.com/maps?v=2.0&key=d124d3ae2818bf6f9f005f2ed106fbe5"></script>
</head>
<body>

<div class="header">
  <h1>é€‰æ‹©ä½ç½®</h1>
  <div class="info">ç‚¹å‡»åœ°å›¾é€‰ç‚¹ï¼Œå¦‚ä½ç½®åç¦»è¯·ç‚¹å‡»â€œåˆ‡æ¢çº åâ€</div>
</div>

<div id="map"></div>

<button class="locate-btn" onclick="startLocation()" title="é‡æ–°å®šä½">ğŸ“</button>

<div class="controls">
  <div class="coord-display" id="coord-display">æ­£åœ¨è·å–ä½ç½®...</div>
  <div class="btn-group">
    <button class="fix-btn" onclick="toggleCorrection()">åˆ‡æ¢çº å</button>
    <button class="confirm-btn" id="confirm-btn" onclick="confirmLocation()" disabled>ç¡®è®¤å¹¶å¼€å§‹</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // --- å…¨å±€å˜é‡ ---
  let map, marker, userMarker;
  let selectedLat, selectedLon;
  let rawUserLat, rawUserLon; // åŸå§‹å®šä½åæ ‡
  let isCorrected = true; // é»˜è®¤å¼€å¯çº å(WGS84->GCJ02)

  // é»˜è®¤ä¸­å¿ƒç‚¹ (å¦‚æœæ²¡æœ‰å®šä½åˆ°ï¼Œæ˜¾ç¤ºè¿™é‡Œ)
  const DEFAULT_POS = [118.912787, 32.103828]; // å—äº¬å¤§å­¦é™„è¿‘

  // --- çº¯æ•°å­¦çº åç®—æ³• (WGS84 è½¬ GCJ02) ---
  const PI = 3.1415926535897932384626;
  const a = 6378245.0;
  const ee = 0.00669342162296594323;

  function transformLat(x, y) {
    let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
    ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
    ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
    ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
    return ret;
  }

  function transformLon(x, y) {
    let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
    ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
    ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
    ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
    return ret;
  }

  function wgs84ToGcj02(lat, lon) {
    if (outOfChina(lat, lon)) return [lon, lat];
    let dLat = transformLat(lon - 105.0, lat - 35.0);
    let dLon = transformLon(lon - 105.0, lat - 35.0);
    let radLat = lat / 180.0 * PI;
    let magic = Math.sin(radLat);
    magic = 1 - ee * magic * magic;
    let sqrtMagic = Math.sqrt(magic);
    dLat = (dLat * 180.0) / ((a * (1 - ee)) / (magic * sqrtMagic) * PI);
    dLon = (dLon * 180.0) / (a / sqrtMagic * Math.cos(radLat) * PI);
    return [lon + dLon, lat + dLat]; // è¿”å› [lng, lat]
  }

  function outOfChina(lat, lon) {
    if (lon < 72.004 || lon > 137.8347) return true;
    if (lat < 0.8293 || lat > 55.8271) return true;
    return false;
  }

  // --- é¡µé¢é€»è¾‘ ---

  window.onload = function() {
    initMap();
    startLocation(); // é¡µé¢åŠ è½½åè‡ªåŠ¨å¼€å§‹å®šä½
  };

  function initMap() {
    map = new AMap.Map("map", {
      viewMode: "3D",
      zoom: 16,
      center: DEFAULT_POS,
      mapStyle: "amap://styles/dark",
    });

    // ç‚¹å‡»åœ°å›¾é€‰ç‚¹äº‹ä»¶
    map.on('click', function(e) {
      updateSelectedPosition(e.lnglat.getLat(), e.lnglat.getLng());
    });
  }

  // æ ¸å¿ƒå®šä½é€»è¾‘
  function startLocation() {
    showToast("æ­£åœ¨è·å–GPSä¿¡å·...");
    document.getElementById('coord-display').textContent = "æ­£åœ¨å®šä½...";

    if (!navigator.geolocation) {
      showToast("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå®šä½");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      function(position) {
        // 1. è·å–æµè§ˆå™¨åŸå§‹åæ ‡ (WGS84)
        rawUserLat = position.coords.latitude;
        rawUserLon = position.coords.longitude;
        const accuracy = position.coords.accuracy;

        console.log("åŸå§‹åæ ‡(WGS84):", rawUserLat, rawUserLon, "ç²¾åº¦:", accuracy);

        // 2. åº”ç”¨ç®—æ³•å¹¶æ˜¾ç¤º
        applyLocationToMap(accuracy);
      },
      function(error) {
        console.error(error);
        let msg = "å®šä½å¤±è´¥";
        switch(error.code) {
          case 1: msg = "ç”¨æˆ·æ‹’ç»äº†å®šä½æƒé™"; break;
          case 2: msg = "æ— æ³•è·å–ä½ç½®(è¯·æ‰“å¼€GPS)"; break;
          case 3: msg = "å®šä½è¶…æ—¶"; break;
        }
        showToast(msg);
        
        // å¤±è´¥åå°è¯•ä½¿ç”¨é«˜å¾· IP å®šä½ä½œä¸ºå¤‡é€‰ï¼ˆä¸éœ€è¦çº åï¼‰
        fallbackIpLocation();
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  }

  // IP å®šä½å¤‡é€‰
  function fallbackIpLocation() {
    showToast("åˆ‡æ¢è‡³ç½‘ç»œå®šä½...");
    AMap.plugin('AMap.Geolocation', function() {
      const geolocation = new AMap.Geolocation({
        enableHighAccuracy: false, 
        timeout: 5000,
      });
      geolocation.getCurrentPosition(function(status, result) {
        if (status === 'complete') {
          isCorrected = false; // IPå®šä½ç»“æœå·²ç»æ˜¯GCJ02ï¼Œæ— éœ€æ•°å­¦çº å
          rawUserLat = result.position.lat;
          rawUserLon = result.position.lng;
          applyLocationToMap(result.accuracy || 100);
        } else {
          showToast("å®šä½å®Œå…¨å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰ç‚¹");
          document.getElementById('coord-display').textContent = "å®šä½å¤±è´¥ï¼Œè¯·ç‚¹å‡»åœ°å›¾é€‰æ‹©";
        }
      });
    });
  }

  // å°†è®¡ç®—åçš„åæ ‡åº”ç”¨åˆ°åœ°å›¾
  function applyLocationToMap(accuracy) {
    let finalLat = rawUserLat;
    let finalLon = rawUserLon;

    // å¦‚æœå¼€å¯äº†çº å(é»˜è®¤å¼€å¯)ï¼Œåº”ç”¨æ•°å­¦å…¬å¼
    if (isCorrected) {
      const gcj = wgs84ToGcj02(rawUserLat, rawUserLon);
      finalLon = gcj[0];
      finalLat = gcj[1];
    }

    // 1. ç»˜åˆ¶â€œæˆ‘çš„ä½ç½®â€è“ç‚¹
    if (!userMarker) {
      userMarker = new AMap.Marker({
        map: map,
        content: '<div style="width:16px;height:16px;background:#3b82f6;border:2px solid #fff;border-radius:50%;box-shadow:0 0 10px rgba(59,130,246,0.5);"></div>',
        anchor: 'center',
        offset: new AMap.Pixel(0, 0)
      });
    }
    userMarker.setPosition([finalLon, finalLat]);
    
    // 2. ç§»åŠ¨åœ°å›¾ä¸­å¿ƒ
    map.setCenter([finalLon, finalLat]);
    map.setZoom(17);

    // 3. è‡ªåŠ¨å°†â€œæˆ‘çš„ä½ç½®â€è®¾ä¸ºâ€œé€‰ä¸­ç‚¹â€
    updateSelectedPosition(finalLat, finalLon);
    
    showToast(`å®šä½æˆåŠŸ (${isCorrected ? 'å·²çº å' : 'åŸå§‹'})`);
  }

  // æ‰‹åŠ¨åˆ‡æ¢çº åæ¨¡å¼ (è§£å†³éƒ¨åˆ†æµè§ˆå™¨è‡ªå¸¦çº åå¯¼è‡´äºŒæ¬¡åç§»çš„é—®é¢˜)
  function toggleCorrection() {
    if (!rawUserLat) {
      showToast("è¯·å…ˆç­‰å¾…å®šä½å®Œæˆ");
      return;
    }
    isCorrected = !isCorrected; 
    applyLocationToMap(0); 
  }

  // æ›´æ–°é€‰ä¸­ç‚¹ UI
  function updateSelectedPosition(lat, lon) {
    selectedLat = lat;
    selectedLon = lon;

    // ç§»åŠ¨çº¢ç‚¹æ ‡è®°
    if (!marker) {
      marker = new AMap.Marker({
        map: map,
        icon: new AMap.Icon({
          image: "https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png",
          size: new AMap.Size(25, 34),
          imageSize: new AMap.Size(25, 34)
        }),
        offset: new AMap.Pixel(-12.5, -34),
        animation: 'AMAP_ANIMATION_DROP'
      });
    }
    marker.setPosition([lon, lat]);

    // æ›´æ–°æ–‡å­—
    document.getElementById('coord-display').innerHTML = 
      `çº¬åº¦: ${lat.toFixed(6)} | ç»åº¦: ${lon.toFixed(6)}`;
    
    document.getElementById('confirm-btn').disabled = false;
  }

  // --- è¿™é‡Œä¿®å¤äº†æ ¸å¿ƒè·³è½¬åŠŸèƒ½ ---
  function confirmLocation() {
    if (selectedLat && selectedLon) {
      // æŒ‰é’®å˜æ›´ä¸ºåŠ è½½çŠ¶æ€
      const btn = document.getElementById('confirm-btn');
      btn.textContent = 'æ­£åœ¨è·³è½¬...';
      btn.disabled = true;
      
      // æ‰§è¡Œè·³è½¬ï¼Œæºå¸¦å‚æ•°
      setTimeout(() => {
        window.location.href = `run.html?lat=${selectedLat}&lon=${selectedLon}`;
      }, 200);
    }
  }

  function showToast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.style.opacity = '1';
    setTimeout(() => { el.style.opacity = '0'; }, 2000);
  }

</script>
</body>
</html>
