<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é€‰æ‹©ä½ç½® (ç¦»çº¿ç®—æ³•ç‰ˆ)</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { margin: 0; height: 100%; overflow: hidden; background: #0f172a; color: #e2e8f0; font-family: sans-serif; }
  
  /* å¤´éƒ¨æ ·å¼ */
  .header {
    background: rgba(30, 41, 59, 0.95);
    padding: 16px 20px;
    text-align: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 10;
    position: relative;
  }
  h1 { font-size: 1.2em; margin: 0; color: #fff; }
  .info { font-size: 0.8em; color: #94a3b8; margin-top: 5px; }

  /* åœ°å›¾å®¹å™¨ */
  #map { width: 100%; height: calc(100% - 140px); }

  /* åº•éƒ¨æ§ä»¶ */
  .controls {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: rgba(15, 23, 42, 0.95);
    padding: 15px;
    border-top: 1px solid rgba(255,255,255,0.1);
    z-index: 100;
    display: flex; flex-direction: column; gap: 10px;
  }
  .coord-display {
    font-size: 12px; color: #cbd5e1; text-align: center;
    background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px;
  }
  .btn-group { display: flex; gap: 10px; }
  button {
    flex: 1; padding: 12px; border: none; border-radius: 8px;
    font-weight: 600; cursor: pointer; transition: 0.2s;
  }
  .confirm-btn { background: #3b82f6; color: white; }
  .confirm-btn:disabled { background: #475569; color: #94a3b8; }
  .fix-btn { background: #64748b; color: white; }

  /* å®šä½æŒ‰é’® */
  .locate-btn {
    position: fixed; bottom: 160px; right: 20px;
    width: 48px; height: 48px; border-radius: 50%;
    background: #3b82f6; color: white; border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    font-size: 24px; z-index: 99; cursor: pointer;
  }

  /* æç¤ºæ¡† */
  .toast {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.8); color: white; padding: 10px 20px;
    border-radius: 20px; font-size: 14px; opacity: 0; pointer-events: none;
    transition: opacity 0.3s; z-index: 9999;
  }
</style>

<script src="https://webapi.amap.com/maps?v=2.0&key=d124d3ae2818bf6f9f005f2ed106fbe5"></script>
</head>
<body>

<div class="header">
  <h1>é€‰æ‹©ä½ç½®</h1>
  <div class="info">å¦‚ä½ç½®æœ‰åå·®ï¼Œè¯·ç‚¹å‡»åº•éƒ¨çš„â€œåˆ‡æ¢çº åâ€</div>
</div>

<div id="map"></div>

<button class="locate-btn" onclick="startLocation()">ğŸ“</button>

<div class="controls">
  <div class="coord-display" id="coord-display">ç­‰å¾…é€‰æ‹©...</div>
  <div class="btn-group">
    <button class="fix-btn" onclick="toggleCorrection()">åˆ‡æ¢çº å (ä¿®æ­£åå·®)</button>
    <button class="confirm-btn" id="confirm-btn" onclick="confirmLocation()" disabled>ç¡®è®¤ä½ç½®</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // --- å…¨å±€å˜é‡ ---
  let map, marker, userMarker;
  let selectedLat, selectedLon;
  let rawUserLat, rawUserLon; // åŸå§‹å®šä½åæ ‡
  let isCorrected = true; // é»˜è®¤å¼€å¯çº å

  // é»˜è®¤ä¸­å¿ƒç‚¹ (åŒ—äº¬)
  const DEFAULT_POS = [116.397428, 39.90923];

  // --- çº¯æ•°å­¦çº åç®—æ³• (WGS84 è½¬ GCJ02) ---
  // è¿™ä¸ä¾èµ–ç½‘ç»œï¼Œ100% æˆåŠŸï¼Œæ˜¯è§£å†³åå·®çš„æ ¸å¿ƒ
  const PI = 3.1415926535897932384626;
  const a = 6378245.0;
  const ee = 0.00669342162296594323;

  function transformLat(x, y) {
    let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
    ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
    ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
    ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
    return ret;
  }

  function transformLon(x, y) {
    let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
    ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
    ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
    ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
    return ret;
  }

  function wgs84ToGcj02(lat, lon) {
    if (outOfChina(lat, lon)) return [lon, lat];
    let dLat = transformLat(lon - 105.0, lat - 35.0);
    let dLon = transformLon(lon - 105.0, lat - 35.0);
    let radLat = lat / 180.0 * PI;
    let magic = Math.sin(radLat);
    magic = 1 - ee * magic * magic;
    let sqrtMagic = Math.sqrt(magic);
    dLat = (dLat * 180.0) / ((a * (1 - ee)) / (magic * sqrtMagic) * PI);
    dLon = (dLon * 180.0) / (a / sqrtMagic * Math.cos(radLat) * PI);
    return [lon + dLon, lat + dLat]; // è¿”å› [lng, lat]
  }

  function outOfChina(lat, lon) {
    if (lon < 72.004 || lon > 137.8347) return true;
    if (lat < 0.8293 || lat > 55.8271) return true;
    return false;
  }

  // --- åœ°å›¾åŠŸèƒ½ ---

  window.onload = function() {
    initMap();
    startLocation(); // è‡ªåŠ¨å¼€å§‹å®šä½
  };

  function initMap() {
    map = new AMap.Map("map", {
      viewMode: "3D",
      zoom: 16,
      center: DEFAULT_POS,
      mapStyle: "amap://styles/dark",
    });

    // ç‚¹å‡»é€‰ç‚¹äº‹ä»¶
    map.on('click', function(e) {
      updateSelectedPosition(e.lnglat.getLat(), e.lnglat.getLng());
    });
  }

  // æ ¸å¿ƒå®šä½é€»è¾‘
  function startLocation() {
    showToast("æ­£åœ¨å®šä½(GPS)...");

    if (!navigator.geolocation) {
      showToast("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå®šä½");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      function(position) {
        // 1. è·å–æµè§ˆå™¨åŸå§‹åæ ‡ (é€šå¸¸æ˜¯ WGS84)
        rawUserLat = position.coords.latitude;
        rawUserLon = position.coords.longitude;
        const accuracy = position.coords.accuracy;

        console.log("åŸå§‹åæ ‡(WGS84):", rawUserLat, rawUserLon, "ç²¾åº¦:", accuracy);

        // 2. æ ¹æ®å½“å‰çš„ isCorrected çŠ¶æ€å†³å®šæ˜¯å¦åº”ç”¨ç®—æ³•
        applyLocationToMap(accuracy);
      },
      function(error) {
        console.error(error);
        let msg = "å®šä½å¤±è´¥";
        switch(error.code) {
          case 1: msg = "ç”¨æˆ·æ‹’ç»äº†å®šä½æƒé™"; break;
          case 2: msg = "æ— æ³•è·å–ä½ç½®(è¯·æ£€æŸ¥GPS)"; break;
          case 3: msg = "å®šä½è¶…æ—¶"; break;
        }
        showToast(msg);
        
        // å¤±è´¥åå°è¯•ä½¿ç”¨é«˜å¾· IP å®šä½ä½œä¸ºå¤‡é€‰
        fallbackIpLocation();
      },
      {
        enableHighAccuracy: true,
        timeout: 8000,
        maximumAge: 0
      }
    );
  }

  // é«˜å¾· IP å®šä½å¤‡é€‰ (å½“ GPS å¤±è´¥æ—¶)
  function fallbackIpLocation() {
    showToast("åˆ‡æ¢è‡³ IP å®šä½...");
    AMap.plugin('AMap.Geolocation', function() {
      const geolocation = new AMap.Geolocation({
        enableHighAccuracy: false, // IPå®šä½ä¸éœ€è¦é«˜ç²¾åº¦
        timeout: 5000,
      });
      geolocation.getCurrentPosition(function(status, result) {
        if (status === 'complete') {
          // IP å®šä½è¿”å›çš„é€šå¸¸å·²ç»æ˜¯ GCJ02ï¼Œä¸éœ€è¦å†çº å
          isCorrected = false; // æ ‡è®°ä¸ºæœªç»è¿‡æ•°å­¦çº å
          rawUserLat = result.position.lat;
          rawUserLon = result.position.lng;
          applyLocationToMap(result.accuracy || 100);
        } else {
          showToast("æ— æ³•è·å–ä½ç½®");
        }
      });
    });
  }

  // å°†è®¡ç®—åçš„åæ ‡åº”ç”¨åˆ°åœ°å›¾
  function applyLocationToMap(accuracy) {
    let finalLat = rawUserLat;
    let finalLon = rawUserLon;

    // å¦‚æœå¼€å¯äº†çº åï¼Œåº”ç”¨æ•°å­¦å…¬å¼
    if (isCorrected) {
      const gcj = wgs84ToGcj02(rawUserLat, rawUserLon);
      finalLon = gcj[0];
      finalLat = gcj[1];
    }

    // ç»˜åˆ¶/ç§»åŠ¨â€œæˆ‘çš„ä½ç½®â€è“ç‚¹
    if (!userMarker) {
      userMarker = new AMap.Marker({
        map: map,
        icon: new AMap.Icon({
          image: "https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png",
          size: new AMap.Size(19, 31),
          imageSize: new AMap.Size(19, 31)
        }),
        anchor: 'bottom-center',
        offset: new AMap.Pixel(0, 0)
      });
    }
    userMarker.setPosition([finalLon, finalLat]);
    
    // ç§»åŠ¨åœ°å›¾è§†è§’
    map.setCenter([finalLon, finalLat]);
    map.setZoom(17);

    // è‡ªåŠ¨é€‰ä¸­å½“å‰ç‚¹
    updateSelectedPosition(finalLat, finalLon);
    
    showToast(`å®šä½æˆåŠŸ (æ¨¡å¼: ${isCorrected ? 'å·²çº å' : 'åŸå§‹'})`);
  }

  // æ‰‹åŠ¨åˆ‡æ¢çº åæ¨¡å¼
  function toggleCorrection() {
    if (!rawUserLat) {
      showToast("è¯·å…ˆè·å–å®šä½");
      return;
    }
    isCorrected = !isCorrected; // åˆ‡æ¢å¼€å…³
    applyLocationToMap(0); // é‡æ–°è®¡ç®—å¹¶æ¸²æŸ“
  }

  // æ›´æ–°é€‰ä¸­ç‚¹ UI
  function updateSelectedPosition(lat, lon) {
    selectedLat = lat;
    selectedLon = lon;

    // ç§»åŠ¨çº¢ç‚¹æ ‡è®°
    if (!marker) {
      marker = new AMap.Marker({
        map: map,
        icon: new AMap.Icon({
          image: "https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png",
          size: new AMap.Size(25, 34),
          imageSize: new AMap.Size(25, 34)
        }),
        offset: new AMap.Pixel(-12.5, -34)
      });
    }
    marker.setPosition([lon, lat]);

    // æ›´æ–°æ–‡å­—
    document.getElementById('coord-display').innerHTML = 
      `çº¬åº¦: ${lat.toFixed(6)}<br>ç»åº¦: ${lon.toFixed(6)}`;
    
    document.getElementById('confirm-btn').disabled = false;
  }

  function confirmLocation() {
    if (selectedLat && selectedLon) {
      // åœ¨è¿™é‡Œæ‰§è¡Œè·³è½¬
      // window.location.href = `run.html?lat=${selectedLat}&lon=${selectedLon}`;
      alert(`å·²ç¡®è®¤åæ ‡:\n${selectedLat}, ${selectedLon}`);
    }
  }

  function showToast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.style.opacity = '1';
    setTimeout(() => { el.style.opacity = '0'; }, 2000);
  }

</script>
</body>
</html>
