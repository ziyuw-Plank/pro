<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>é€‰æ‹©ä½ç½® - å«æ˜Ÿåœ°å›¾ç‰ˆ</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  /* ä½¿ç”¨ dvh è§£å†³ç§»åŠ¨ç«¯åœ°å€æ é«˜åº¦è·³åŠ¨é—®é¢˜ */
  html, body { 
    margin: 0; 
    height: 100dvh; 
    overflow: hidden; 
    background: #0f172a; 
    color: #e2e8f0; 
    font-family: -apple-system, "Helvetica Neue", "PingFang SC", sans-serif; 
  }
  
  .header {
    background: rgba(30, 41, 59, 0.95);
    padding: 16px 20px;
    text-align: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 10;
    position: relative;
    backdrop-filter: blur(10px);
  }
  h1 { font-size: 1.1em; margin: 0; color: #fff; letter-spacing: 1px; }
  .info { font-size: 0.75em; color: #94a3b8; margin-top: 4px; }

  /* åœ°å›¾å®¹å™¨ */
  #map { 
    width: 100%; 
    height: calc(100% - 140px); 
    background: #1e293b; /* æ¸²æŸ“å‰çš„å ä½è‰² */
  }

  .controls {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: rgba(15, 23, 42, 0.95);
    padding: 15px 20px 25px 20px;
    border-top: 1px solid rgba(255,255,255,0.1);
    z-index: 100;
    display: flex; flex-direction: column; gap: 12px;
    backdrop-filter: blur(10px);
    box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
  }
  
  .coord-display {
    font-size: 12px; color: #cbd5e1; text-align: center;
    background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.1);
    font-family: monospace;
  }
  
  .btn-group { display: flex; gap: 10px; }
  
  button {
    flex: 1; padding: 14px; border: none; border-radius: 10px;
    font-weight: 600; cursor: pointer; transition: all 0.2s;
    font-size: 15px;
    -webkit-tap-highlight-color: transparent;
  }
  
  .confirm-btn { 
    background: linear-gradient(135deg, #3b82f6, #2563eb); 
    color: white; 
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    flex: 1.4;
  }
  .confirm-btn:active { transform: scale(0.96); opacity: 0.9; }
  .confirm-btn:disabled { 
    background: #475569; color: #94a3b8; 
    box-shadow: none; cursor: not-allowed; opacity: 0.6;
  }

  .fix-btn { 
    background: rgba(255,255,255,0.1); 
    color: #e2e8f0; 
    border: 1px solid rgba(255,255,255,0.2);
  }

  .locate-btn {
    position: fixed; bottom: 180px; right: 20px;
    width: 44px; height: 44px; border-radius: 50%;
    background: #3b82f6; color: white; border: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    font-size: 20px; z-index: 99; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }

  .toast {
    position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.8); color: white; padding: 8px 20px;
    border-radius: 20px; font-size: 13px; opacity: 0; pointer-events: none;
    transition: opacity 0.3s; z-index: 9999;
  }
</style>

<script src="https://webapi.amap.com/maps?v=2.0&key=d124d3ae2818bf6f9f005f2ed106fbe5"></script>
</head>
<body>

<div class="header">
  <h1>é€‰æ‹©ä½ç½®</h1>
  <div class="info">å«æ˜Ÿæ¨¡å¼ï¼šè‹¥åç¦»è¯·ç‚¹â€œåˆ‡æ¢çº åâ€</div>
</div>

<div id="map"></div>

<button class="locate-btn" onclick="startLocation()">ğŸ“</button>

<div class="controls">
  <div class="coord-display" id="coord-display">æ­£åœ¨åˆå§‹åŒ–å«æ˜Ÿåœ°å›¾...</div>
  <div class="btn-group">
    <button class="fix-btn" onclick="toggleCorrection()">åˆ‡æ¢çº å</button>
    <button class="confirm-btn" id="confirm-btn" onclick="confirmLocation()" disabled>ç¡®è®¤å¹¶å¼€å§‹</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  let map, marker, userMarker;
  let selectedLat, selectedLon;
  let rawUserLat, rawUserLon;
  let isCorrected = true; 

  const DEFAULT_POS = [118.912787, 32.103828];

  // --- WGS84 è½¬ GCJ02 ç®—æ³• ---
  const PI = 3.1415926535897932384626;
  const a = 6378245.0;
  const ee = 0.00669342162296594323;

  function transformLat(x, y) {
    let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
    ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
    ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
    ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
    return ret;
  }

  function transformLon(x, y) {
    let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
    ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
    ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
    ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
    return ret;
  }

  function wgs84ToGcj02(lat, lon) {
    if (lon < 72.004 || lon > 137.8347 || lat < 0.8293 || lat > 55.8271) return [lon, lat];
    let dLat = transformLat(lon - 105.0, lat - 35.0);
    let dLon = transformLon(lon - 105.0, lat - 35.0);
    let radLat = lat / 180.0 * PI;
    let magic = Math.sin(radLat);
    magic = 1 - ee * magic * magic;
    let sqrtMagic = Math.sqrt(magic);
    dLat = (dLat * 180.0) / ((a * (1 - ee)) / (magic * sqrtMagic) * PI);
    dLon = (dLon * 180.0) / (a / sqrtMagic * Math.cos(radLat) * PI);
    return [lon + dLon, lat + dLat];
  }

  // --- åœ°å›¾é€»è¾‘ ---

  window.onload = function() {
    initMap();
    startLocation();
  };

  function initMap() {
    // å®ä¾‹åŒ–å«æ˜Ÿå›¾å±‚å’Œè·¯ç½‘å›¾å±‚
    const satelliteLayer = new AMap.TileLayer.Satellite();
    const roadNetLayer = new AMap.TileLayer.RoadNet();

    map = new AMap.Map("map", {
      viewMode: "2D", // å¼ºåˆ¶ 2D æ¨¡å¼ï¼Œè§£å†³ç§»åŠ¨ç«¯ç™½å±
      zoom: 17,
      center: DEFAULT_POS,
      layers: [satelliteLayer, roadNetLayer] // åŠ è½½å«æ˜Ÿ+è·¯ç½‘
    });

    map.on('click', function(e) {
      updateSelectedPosition(e.lnglat.getLat(), e.lnglat.getLng());
    });

    // è§£å†³å®¹å™¨å°ºå¯¸å˜åŒ–å¯¼è‡´çš„æ¸²æŸ“é—®é¢˜
    map.on('complete', () => {
      map.resize();
    });
  }

  function startLocation() {
    showToast("è¯·æ±‚å®šä½ä¸­...");
    if (!navigator.geolocation) {
      showToast("æµè§ˆå™¨ä¸æ”¯æŒå®šä½");
      fallbackIpLocation();
      return;
    }

    navigator.geolocation.getCurrentPosition(
      function(position) {
        rawUserLat = position.coords.latitude;
        rawUserLon = position.coords.longitude;
        applyLocationToMap();
      },
      function(error) {
        showToast("GPSå®šä½å¤±è´¥ï¼Œå°è¯•ç½‘ç»œå®šä½");
        fallbackIpLocation();
      },
      { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
    );
  }

  function fallbackIpLocation() {
    AMap.plugin('AMap.Geolocation', function() {
      const geolocation = new AMap.Geolocation({ enableHighAccuracy: false, timeout: 5000 });
      geolocation.getCurrentPosition(function(status, result) {
        if (status === 'complete') {
          isCorrected = false; 
          rawUserLat = result.position.lat;
          rawUserLon = result.position.lng;
          applyLocationToMap();
        } else {
          document.getElementById('coord-display').textContent = "å®šä½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»åœ°å›¾é€‰ç‚¹";
        }
      });
    });
  }

  function applyLocationToMap() {
    let finalLat = rawUserLat;
    let finalLon = rawUserLon;

    if (isCorrected) {
      const gcj = wgs84ToGcj02(rawUserLat, rawUserLon);
      finalLon = gcj[0];
      finalLat = gcj[1];
    }

    if (!userMarker) {
      userMarker = new AMap.Marker({
        map: map,
        content: '<div style="width:18px;height:18px;background:#3b82f6;border:2px solid #fff;border-radius:50%;box-shadow:0 0 12px #3b82f6;"></div>',
        anchor: 'center'
      });
    }
    userMarker.setPosition([finalLon, finalLat]);
    map.setCenter([finalLon, finalLat]);
    updateSelectedPosition(finalLat, finalLon);
    showToast(isCorrected ? "å·²åº”ç”¨çº å" : "å®šä½æˆåŠŸ");
  }

  function toggleCorrection() {
    if (!rawUserLat) return showToast("ç­‰å¾…å®šä½ä¸­");
    isCorrected = !isCorrected;
    applyLocationToMap();
  }

  function updateSelectedPosition(lat, lon) {
    selectedLat = lat;
    selectedLon = lon;
    if (!marker) {
      marker = new AMap.Marker({
        map: map,
        icon: new AMap.Icon({
          image: "https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png",
          size: new AMap.Size(25, 34),
          imageSize: new AMap.Size(25, 34)
        }),
        offset: new AMap.Pixel(-12, -34),
        animation: 'AMAP_ANIMATION_DROP'
      });
    }
    marker.setPosition([lon, lat]);
    document.getElementById('coord-display').innerHTML = `çº¬:${lat.toFixed(6)} | ç»:${lon.toFixed(6)}`;
    document.getElementById('confirm-btn').disabled = false;
  }

  function confirmLocation() {
    const btn = document.getElementById('confirm-btn');
    btn.textContent = 'è·³è½¬ä¸­...';
    btn.disabled = true;
    setTimeout(() => {
      window.location.href = `run.html?lat=${selectedLat}&lon=${selectedLon}`;
    }, 300);
  }

  function showToast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.style.opacity = '1';
    setTimeout(() => { el.style.opacity = '0'; }, 2000);
  }
</script>
</body>
</html>
