<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è½¦è¾†ä½ç½®åœ°å›¾ - å«æ˜Ÿç‰ˆ</title>
<style>
  * { box-sizing: border-box; }

  html, body {
    margin: 0;
    height: 100dvh; /* é€‚é…ç§»åŠ¨ç«¯é«˜åº¦ */
    overflow: hidden;
    background: #0f172a;
    color: #e2e8f0;
    font-family: -apple-system, "Segoe UI", "PingFang SC", sans-serif;
  }

  #map { width: 100%; height: 100%; background: #1e293b; }

  /* åŠ è½½çŠ¶æ€ */
  .loading-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(15, 23, 42, 0.95);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 3000; backdrop-filter: blur(5px);
  }

  .spinner {
    width: 40px; height: 40px;
    border: 3px solid rgba(251, 191, 36, 0.2);
    border-top-color: #fbbf24;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text { margin-top: 15px; font-size: 14px; color: #fbbf24; }

  /* æ§åˆ¶é¢æ¿ */
  .control-panel {
    position: fixed; top: 15px; right: 15px;
    background: rgba(30, 41, 59, 0.9);
    padding: 12px; border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    z-index: 1000; min-width: 180px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .control-panel h3 {
    margin: 0 0 10px 0; font-size: 15px; color: #fbbf24;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 6px;
  }

  .stat-item { display: flex; justify-content: space-between; margin: 6px 0; font-size: 13px; }
  .stat-label { color: #94a3b8; }
  .stat-value { color: #fbbf24; font-weight: bold; }

  .refresh-btn {
    width: 100%; margin-top: 8px; padding: 10px;
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: #1e293b; border: none; border-radius: 8px;
    font-size: 13px; font-weight: bold; cursor: pointer;
  }

  /* ä¿¡æ¯çª—ä½“æ ·å¼ */
  .info-window {
    background: #1e293b; color: #e2e8f0;
    padding: 10px; border-radius: 8px;
    font-size: 13px; border: 1px solid #fbbf24;
    min-width: 160px;
  }

  .info-row { display: flex; justify-content: space-between; margin: 5px 0; }
  .info-label { color: #94a3b8; }
  .info-value { color: #fbbf24; font-weight: 600; }

  .copy-btn {
    cursor: pointer; padding: 2px 8px;
    background: rgba(251, 191, 36, 0.2);
    border-radius: 4px; transition: all 0.2s;
  }

  .copy-btn.pressing { background: #3b82f6; }

  .nav-hint {
    position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
    background: #3b82f6; color: white; padding: 4px 8px;
    border-radius: 4px; font-size: 11px; white-space: nowrap;
  }

  /* åº•éƒ¨ç½‘é¡µå¯¼èˆªå…¥å£ */
  .web-nav-banner {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: rgba(30, 41, 59, 0.98); padding: 15px;
    z-index: 2000; border-top: 2px solid #3b82f6;
    display: none;
  }

  .web-nav-banner.show { display: block; animation: slideUp 0.3s ease; }

  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

  .web-nav-content { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
  .web-nav-btn {
    padding: 8px 16px; background: #3b82f6; color: white;
    border: none; border-radius: 6px; font-weight: bold;
  }

  .copy-toast {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    background: #22c55e; color: white; padding: 10px 20px;
    border-radius: 8px; z-index: 5000; font-size: 14px;
  }

  @media (max-width: 600px) {
    .control-panel { top: 10px; right: 10px; left: 10px; min-width: auto; }
  }
</style>

<script src="https://webapi.amap.com/maps?v=2.0&key=d124d3ae2818bf6f9f005f2ed106fbe5"></script>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay">
  <div class="spinner"></div>
  <div class="loading-text">æ­£åœ¨åŠ è½½å«æ˜Ÿæ•°æ®...</div>
</div>

<div id="map"></div>

<div class="control-panel">
  <h3>ğŸš— è½¦è¾†ç»Ÿè®¡</h3>
  <div class="stat-item">
    <span class="stat-label">æ€»æ•°</span>
    <span class="stat-value" id="totalCars">0</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">æœ€è¿‘</span>
    <span class="stat-value" id="nearestCar">-</span>
  </div>
  <button class="refresh-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
</div>

<div id="webNavBanner" class="web-nav-banner">
  <div class="web-nav-content">
    <div style="font-size:13px">æœªå”¤èµ·APPï¼Ÿå¯å°è¯•ç½‘é¡µç‰ˆå¯¼èˆª</div>
    <button class="web-nav-btn" onclick="openWebNav()">ç½‘é¡µå¯¼èˆª</button>
  </div>
</div>

<script>
let map = null;
let markers = [];
let currentLat = null;
let currentLon = null;
let pendingNavData = null;

async function loadCars(lat, lon) {
  const target = `https://newmapi.7mate.cn/api/new/surrounding/car?latitude=${lat}&longitude=${lon}`;
  const proxyUrl = `https://cors-prfunction-yoolvkcvju.cn-hangzhou.fcapp.run?url=${encodeURIComponent(target)}`;

  try {
    const res = await fetch(proxyUrl);
    const data = await res.json();
    const groups = data?.data || {};
    const allCars = [];

    for (const group of Object.values(groups)) {
      if (Array.isArray(group.cars)) {
        allCars.push(...group.cars);
      }
    }

    if (!allCars.length) {
      showToast("å‘¨è¾¹æš‚æ— è½¦è¾†", true);
      hideLoading();
      return;
    }

    initMap(allCars, lat, lon);
    updateStats(allCars);
    hideLoading();
    
  } catch (err) {
    showToast("åŠ è½½å¤±è´¥: " + err.message, true);
    hideLoading();
  }
}

function initMap(cars, lat, lon) {
  if (markers.length > 0) {
    markers.forEach(m => m.setMap(null));
    markers = [];
  }

  if (!map) {
    // å®ä¾‹åŒ–å«æ˜Ÿå’Œè·¯ç½‘å›¾å±‚
    const satellite = new AMap.TileLayer.Satellite();
    const roadNet = new AMap.TileLayer.RoadNet();

    map = new AMap.Map("map", {
      viewMode: "2D", // è§£å†³æ‰‹æœºç«¯ç™½å±çš„å…³é”®
      zoom: 16,
      center: [lon, lat],
      layers: [satellite, roadNet]
    });

    // åŸºå‡†ç‚¹
    new AMap.Marker({
      position: [lon, lat],
      map,
      icon: new AMap.Icon({
        image: "https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png",
        size: new AMap.Size(30, 40),
        imageSize: new AMap.Size(30, 40)
      }),
      zIndex: 100
    });
  }

  cars.forEach(car => {
    const marker = new AMap.Marker({
      position: [car.longitude, car.latitude],
      map,
      icon: new AMap.Icon({
        image: "https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png",
        size: new AMap.Size(25, 34),
        imageSize: new AMap.Size(25, 34)
      })
    });

    markers.push(marker);

    const infoContent = `
      <div class="info-window">
        <div class="info-row">
          <span class="info-label">ç¼–å·</span>
          <span class="info-value copy-btn" 
                data-lon="${car.longitude}" data-lat="${car.latitude}" data-number="${car.number}"
                onclick="handleNumberClick(event)" ontouchstart="handleTouchStart(event)"
                ontouchend="handleTouchEnd(event)">${car.number}</span>
        </div>
        <div class="info-row">
          <span class="info-label">ç”µæ± </span>
          <span class="info-value">${car.battery_name || 'N/A'}</span>
        </div>
        <div class="info-row">
          <span class="info-label">è·ç¦»</span>
          <span class="info-value">${car.distance}m</span>
        </div>
      </div>`;
    
    const infoWindow = new AMap.InfoWindow({ content: infoContent, offset: new AMap.Pixel(0, -30) });
    marker.on("click", () => infoWindow.open(map, marker.getPosition()));
  });

  if (cars.length > 0) {
    map.setFitView(markers, false, [60, 60, 60, 60]);
  }
}

function updateStats(cars) {
  document.getElementById('totalCars').textContent = cars.length;
  const nearest = cars.reduce((min, car) => parseFloat(car.distance) < parseFloat(min.distance) ? car : min);
  document.getElementById('nearestCar').textContent = nearest.number;
}

// å¯¼èˆªä¸å¤åˆ¶é€»è¾‘
let longPressTimer = null;
let isLongPress = false;

function handleNumberClick(event) {
  if (isLongPress) return;
  copyNumber(event.target.dataset.number);
}

function handleTouchStart(event) {
  isLongPress = false;
  const target = event.target;
  target.classList.add('pressing');
  
  const hint = document.createElement('div');
  hint.className = 'nav-hint';
  hint.textContent = 'æŒ‰ä½å¯¼èˆª';
  target.appendChild(hint);

  longPressTimer = setTimeout(() => {
    isLongPress = true;
    navigateToAmap(target.dataset.lon, target.dataset.lat, target.dataset.number);
    target.classList.remove('pressing');
  }, 800);
}

function handleTouchEnd(event) {
  clearTimeout(longPressTimer);
  const target = event.target;
  target.classList.remove('pressing');
  const hint = target.querySelector('.nav-hint');
  if (hint) hint.remove();
}

function navigateToAmap(lon, lat, name) {
  pendingNavData = { lon, lat, name };
  const url = `amapuri://route/plan/?dlat=${lat}&dlon=${lon}&dname=è½¦è¾†${name}&dev=0&t=0`;
  window.location.href = url;
  document.getElementById('webNavBanner').classList.add('show');
}

function openWebNav() {
  const { lon, lat, name } = pendingNavData;
  window.open(`https://uri.amap.com/navigation?to=${lon},${lat},è½¦è¾†${name}&mode=car&callnative=0`);
}

function copyNumber(text) {
  const el = document.createElement('textarea');
  el.value = text;
  document.body.appendChild(el);
  el.select();
  document.execCommand('copy');
  document.body.removeChild(el);
  showToast("å·²å¤åˆ¶: " + text);
}

function showToast(msg, isErr = false) {
  const t = document.createElement('div');
  t.className = 'copy-toast';
  if(isErr) t.style.background = '#ef4444';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 2000);
}

function hideLoading() {
  const loader = document.getElementById('loadingOverlay');
  if(loader) loader.style.display = 'none';
}

function refreshData() {
  loadCars(currentLat, currentLon);
}

const params = new URLSearchParams(window.location.search);
currentLat = params.get("lat") || "32.102954";
currentLon = params.get("lon") || "118.911875";
loadCars(currentLat, currentLon);
</script>
</body>
</html>
