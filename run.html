<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è½¦è¾†å®æ™¯ç›‘æ§</title>
<style>
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  html, body {
    margin: 0;
    height: 100dvh; /* é€‚é…ç§»åŠ¨ç«¯é«˜åº¦ */
    overflow: hidden;
    background: #000;
    color: #e2e8f0;
    font-family: -apple-system, "PingFang SC", sans-serif;
  }

  #map { width: 100%; height: 100%; background: #000; }

  /* åŠ è½½é®ç½© */
  .loading-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: #0f172a; display: flex; flex-direction: column;
    align-items: center; justify-content: center; z-index: 3000;
  }

  .spinner {
    width: 40px; height: 40px; border: 3px solid rgba(251, 191, 36, 0.2);
    border-top-color: #fbbf24; border-radius: 50%; animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* é¡¶éƒ¨æ§åˆ¶é¢æ¿ */
  .control-panel {
    position: fixed; top: 12px; right: 12px; left: 12px;
    background: rgba(15, 23, 42, 0.85); padding: 12px; border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); z-index: 1000;
    backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.1);
  }

  @media (min-width: 600px) { .control-panel { width: 220px; left: auto; } }

  .control-panel h3 { margin: 0 0 8px 0; font-size: 14px; color: #fbbf24; }
  .stat-item { display: flex; justify-content: space-between; margin: 4px 0; font-size: 12px; }
  .stat-label { color: #94a3b8; }
  .stat-value { color: #fff; font-weight: bold; }

  .refresh-btn {
    width: 100%; margin-top: 8px; padding: 10px;
    background: #fbbf24; color: #000; border: none;
    border-radius: 6px; font-size: 12px; font-weight: bold;
  }

  /* æ‚¬æµ®ä¿¡æ¯çª— */
  .custom-info {
    background: #1e293b; color: #fff; padding: 12px;
    border-radius: 8px; border: 1px solid #fbbf24; min-width: 150px;
  }
  .info-row { font-size: 12px; margin: 5px 0; display: flex; justify-content: space-between; }
  .btn-row { margin-top: 10px; display: flex; gap: 10px; border-top: 1px solid #334155; padding-top: 8px; }
  .action-btn { color: #fbbf24; cursor: pointer; font-size: 12px; font-weight: bold; }

  .web-nav-banner {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: #1e293b; padding: 15px; z-index: 2000;
    border-top: 2px solid #3b82f6; display: none;
  }
  .web-nav-banner.show { display: block; animation: slideUp 0.3s ease; }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
</style>

<script src="https://webapi.amap.com/maps?v=2.0&key=d124d3ae2818bf6f9f005f2ed106fbe5"></script>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay">
  <div class="spinner"></div>
  <div style="margin-top:10px; color:#fbbf24; font-size:13px;">å®æ™¯åœ°å›¾æ¸²æŸ“ä¸­...</div>
</div>

<div id="map"></div>

<div class="control-panel">
  <h3>ğŸš— å«æ˜Ÿå®æ™¯ç›‘æ§</h3>
  <div class="stat-item">
    <span class="stat-label">é™„è¿‘è½¦è¾†</span>
    <span class="stat-value" id="totalCars">0</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">æœ€è¿‘ç¼–å·</span>
    <span class="stat-value" id="nearestCar">-</span>
  </div>
  <button class="refresh-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°è½¦è¾†ä½ç½®</button>
</div>

<div id="webNavBanner" class="web-nav-banner">
  <div style="display:flex; align-items:center; justify-content:space-between">
    <span style="font-size:13px">APPæœªå“åº”ï¼Ÿè¯·ç‚¹æ­¤å¼€å¯</span>
    <button style="padding:6px 12px; background:#3b82f6; color:#fff; border:none; border-radius:4px" onclick="openWebNav()">ç½‘é¡µç‰ˆå¯¼èˆª</button>
  </div>
</div>

<script>
let map = null;
let markers = [];
let currentLat = null;
let currentLon = null;
let pendingNavData = null;

// åˆå§‹åŒ–å…¥å£
async function startApp() {
  const params = new URLSearchParams(window.location.search);
  currentLat = params.get("lat") || "32.102954";
  currentLon = params.get("lon") || "118.911875";
  
  await loadCars(currentLat, currentLon);
}

async function loadCars(lat, lon) {
  const target = `https://newmapi.7mate.cn/api/new/surrounding/car?latitude=${lat}&longitude=${lon}`;
  const proxyUrl = `https://cors-prfunction-yoolvkcvju.cn-hangzhou.fcapp.run?url=${encodeURIComponent(target)}`;

  try {
    const res = await fetch(proxyUrl);
    const data = await res.json();
    const allCars = [];
    if (data?.data) {
      Object.values(data.data).forEach(g => { if(g.cars) allCars.push(...g.cars); });
    }

    if (!allCars.length) {
      showToast("è¯¥åŒºåŸŸæš‚æ— è½¦è¾†ä¿¡æ¯");
      hideLoading();
      return;
    }

    renderMap(allCars, lat, lon);
    updateStats(allCars);
    hideLoading();
  } catch (err) {
    showToast("æ•°æ®åŠ è½½å¼‚å¸¸");
    hideLoading();
  }
}

function renderMap(cars, lat, lon) {
  if (!map) {
    // å®ä¾‹åŒ–å«æ˜Ÿå›¾å±‚å’Œè·¯ç½‘å›¾å±‚
    const satellite = new AMap.TileLayer.Satellite();
    const roadNet = new AMap.TileLayer.RoadNet();

    map = new AMap.Map("map", {
      viewMode: "2D",      // å¼ºåˆ¶2Dï¼Œå½»åº•è§£å†³æ‰‹æœºé»‘å±/ç™½å±é—®é¢˜
      zoom: 17,
      center: [parseFloat(lon), parseFloat(lat)],
      layers: [satellite, roadNet] // æ ¸å¿ƒï¼šæ˜¾å¼åŠ è½½å«æ˜Ÿå›¾
    });

    // ç»˜åˆ¶ä¸­å¿ƒç‚¹ï¼ˆæ‚¨çš„ä½ç½®ï¼‰
    new AMap.Marker({
      position: [parseFloat(lon), parseFloat(lat)],
      map: map,
      content: '<div style="width:14px;height:14px;background:#ff4d4f;border:2px solid #fff;border-radius:50%;box-shadow:0 0 10px #ff4d4f"></div>',
      zIndex: 200
    });
  }

  // æ¸…é™¤æ—§æ ‡è®°
  markers.forEach(m => m.setMap(null));
  markers = [];

  // æ·»åŠ è½¦è¾†æ ‡è®°
  cars.forEach(car => {
    const m = new AMap.Marker({
      position: [car.longitude, car.latitude],
      map: map,
      offset: new AMap.Pixel(-13, -34),
      icon: new AMap.Icon({
        image: "https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png",
        size: new AMap.Size(26, 34),
        imageSize: new AMap.Size(26, 34)
      })
    });

    const info = new AMap.InfoWindow({
      isCustom: true,
      offset: new AMap.Pixel(0, -40),
      content: createInfoWindowHtml(car)
    });

    m.on('click', () => info.open(map, m.getPosition()));
    markers.push(m);
  });

  // è‡ªåŠ¨ç¼©æ”¾è§†é‡ä»¥åŒ…å«æ‰€æœ‰è½¦è¾†
  if (markers.length > 0) {
    map.setFitView(markers, false, [80, 50, 80, 50]);
  }
}

function createInfoWindowHtml(car) {
  return `
    <div class="custom-info">
      <div class="info-row"><span>ç¼–å·:</span><b>${car.number}</b></div>
      <div class="info-row"><span>è·ç¦»:</span><b>${car.distance}m</b></div>
      <div class="btn-row">
        <div class="action-btn" onclick="copyText('${car.number}')">å¤åˆ¶</div>
        <div class="action-btn" style="color:#3b82f6" onclick="goNav(${car.longitude},${car.latitude},'${car.number}')">å¯¼èˆª</div>
      </div>
    </div>
  `;
}

function updateStats(cars) {
  document.getElementById('totalCars').textContent = cars.length;
  const nearest = cars.reduce((min, c) => parseFloat(c.distance) < parseFloat(min.distance) ? c : min);
  document.getElementById('nearestCar').textContent = nearest.number;
}

function goNav(lon, lat, name) {
  pendingNavData = { lon, lat, name };
  // å°è¯•å”¤èµ·é«˜å¾·APP
  const uri = `amapuri://route/plan/?dlat=${lat}&dlon=${lon}&dname=è½¦è¾†${name}&dev=0&t=0`;
  window.location.href = uri;
  // å»¶æ—¶æ˜¾ç¤ºç½‘é¡µç‰ˆå¤‡ä»½å…¥å£
  setTimeout(() => { document.getElementById('webNavBanner').classList.add('show'); }, 2000);
}

function openWebNav() {
  const { lon, lat, name } = pendingNavData;
  window.open(`https://uri.amap.com/navigation?to=${lon},${lat},è½¦è¾†${name}&mode=car&callnative=0`);
}

function copyText(txt) {
  const input = document.createElement('input');
  input.value = txt;
  document.body.appendChild(input);
  input.select();
  document.execCommand('copy');
  document.body.removeChild(input);
  showToast("ç¼–å·å¤åˆ¶æˆåŠŸ");
}

function showToast(m) {
  const t = document.createElement('div');
  t.style = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.85);color:#fff;padding:12px 24px;border-radius:30px;z-index:9999;font-size:13px;backdrop-filter:blur(5px)";
  t.textContent = m;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 2000);
}

function hideLoading() {
  const loader = document.getElementById('loadingOverlay');
  if(loader) {
    loader.style.opacity = '0';
    loader.style.transition = 'opacity 0.5s ease';
    setTimeout(() => loader.remove(), 500);
  }
}

function refreshData() {
  loadCars(currentLat, currentLon);
}

// å¯åŠ¨
window.onload = startApp;
</script>
</body>
</html>
